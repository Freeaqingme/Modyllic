#!/bin/bash
VERSION=$1
DEFAULT_STABILITY=beta
STABILITY=${2-$DEFAULT_STABILITY}
if [ "$1." == . ]; then
	echo "Form: release-version version [stability]"
	echo "If you don't specify a stability it will default to $DEFAULT_STABILITY"
	exit 1
fi
git tag | perl -ne 'next unless /^v(\d+)[.](\d+)[.](\d+)$/; printf "%03d.%03d.%03d,%s",$1,$2,$3,$_' | sort > release_tags.txt
CURRENT=`tail -1 release_tags.txt | cut -d, -f2`
echo "# Edit this list of commits down to something a user would want to read" > CHANGELOG.new
git log --format="* %s (%aN)" ${CURRENT}.. --ancestry-path  --no-merges >> CHANGELOG.new
VISUAL=${VISUAL-${EDITOR-`which sensible-editor || which vi`}}
$VISUAL CHANGELOG.new
grep -v '^#' CHANGELOG.new > CHANGELOG
rm CHANGELOG.new
php build-package-xml package.xml build.xml $VERSION $STABILITY
git fetch upstream-wiki
git merge -s subtree upstream-wiki/master
git fetch upstream-testlib
git merge -s subtree upstream-testlib/master
git add CHANGELOG
git commit -m"Release Modyllic-$VERSION"
git tag "v$VERSION"
pear package build.xml
